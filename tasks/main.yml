---
- name: Load os-specific variables
  include_vars: "{{ ansible_system }}.yml"

- name: Install certbot
  import_tasks: "install-with-{{ certbot_install_method }}.yml"

- name: Create certbot folders
  file:
    path: "{{ certbot_config_dir }}/{{ item }}"
    state: directory
    group: "{{ certbot_group }}"
    mode: 0755
  loop:
  - live
  - archive

- name: Ensure acl package is installed
  package:
    name: acl
    state: present

- block:
  - name: Set default ACL for live and archive folders
    acl:
      path: "{{ certbot_config_dir }}/{{ item }}"
      entity: users
      etype: group
      permissions: rwx
      default: yes
      state: present
    loop:
    - live
    - archive
  - name: Set ACL for existing content
    acl:
      path: "{{ certbot_config_dir }}/{{ item }}"
      entity: users
      etype: group
      permissions: rwx
      recursive: yes
      state: present
    loop:
    - live
    - archive

- name: Copy certbot cloudflare credential config
  template:
    src: cloudflare.ini.j2
    dest: "{{ certbot_config_dir }}/cloudflare.ini"
    group: "{{ certbot_group }}"
    mode: 0600

- include_tasks: create-cert.yml
  loop: "{{ certbot_certs }}"
  when:
  - certbot_create_if_missing
  loop_control:
    loop_var: cert_item

# Snap, deb and rpm packages use sytemd timers by default for renewal.
# MacOS does have cron but launchd is the "proper" way to do it.
- import_tasks: renew-cron.yml
  when:
  - certbot_auto_renew
  - certbot_install_method == 'pip'
  - ansible_os_family != 'Darwin'

- import_tasks: renew-launchd.yml
  when:
  - certbot_auto_renew
  - ansible_os_family == 'Darwin'
